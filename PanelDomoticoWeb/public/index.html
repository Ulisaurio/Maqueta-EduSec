<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduSec · Panel Domótico</title>

    <!-- Fuente & Tailwind -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- Chart.js para sparklines -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        html {
            font-family: "Inter", sans-serif;
            transition: background-color .2s, color .2s;
        }

        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn .4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sidebar-collapsed aside {
            width: 4rem;
        }

        .sidebar-collapsed .sidebar-text {
            display: none;
        }

        .sidebar-collapsed #toggleSidebarIcon {
            transform: rotate(180deg);
        }
        /* Sparklines */
        .sparkline {
            width: 100%;
            height: 50px;
        }
    </style>
</head>
<body class="h-full bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 select-none">

    <!-- LOGIN -->
    <div id="loginCard" class="flex h-full items-center justify-center">
        <form id="loginForm" class="w-80 p-8 bg-white dark:bg-slate-800 rounded-lg shadow space-y-6 text-center">
            <img src="https://via.placeholder.com/100x100.png?text=EduSec" alt="Logo" class="mx-auto w-24 h-24 rounded-full shadow" />
            <h1 class="text-3xl font-bold">EduSec</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400">Panel Domótico Inteligente</p>
            <input id="user" placeholder="Usuario" class="w-full px-3 py-2 rounded border border-slate-300 dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-indigo-500" />
            <input id="pass" type="password" placeholder="Contraseña" class="w-full px-3 py-2 rounded border border-slate-300 dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-indigo-500" />
            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded">Entrar</button>
            <p id="loginError" class="text-sm text-red-500 hidden"></p>
        </form>
    </div>

    <!-- Overlay de carga -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
        <div class="text-white text-xl animate-pulse">Cargando panel…</div>
    </div>

    <!-- PANEL PRINCIPAL -->
    <div id="panel" class="hidden h-full flex overflow-hidden">
        <!-- SIDEBAR -->
        <aside class="w-60 bg-white dark:bg-slate-800 shadow flex flex-col transition-all">
            <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700">
                <span class="text-2xl font-bold sidebar-text">EduSec</span>
                <button id="toggleSidebar" class="p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700">
                    <i data-feather="chevron-left" id="toggleSidebarIcon"></i>
                </button>
            </div>
            <nav id="menu" class="flex-1 p-2 space-y-2"></nav>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 text-sm">
                <p class="sidebar-text">Usuario: <span id="lblUser" class="font-medium">-</span></p>
                <button id="logoutBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded mt-3">Salir</button>
            </div>
        </aside>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Barra superior -->
            <header class="flex items-center justify-between px-6 h-14 border-b border-slate-200 dark:border-slate-700 bg-white/60 dark:bg-slate-800/60 backdrop-blur">
                <div class="flex items-center gap-4">
                    <i data-feather="clock"></i>
                    <span id="clockNow" class="text-sm"></span>
                    <div id="demoToggle" class="toggle-demo">
                        <label for="demoModeCheckbox" class="cursor-pointer">Modo Demo</label>
                        <input type="checkbox" id="demoModeCheckbox" />
                    </div>
                </div>
                <button id="themeBtn" class="p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700">
                    <i data-feather="moon"></i>
                </button>
            </header>
            <main id="content" class="flex-1 overflow-y-auto p-6 space-y-8 fade-in"></main>
        </div>
    </div>

    <!-- Toasts -->
    <div id="toastContainer" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <script>
        // Generadores de tarjetas
        function card(icon, title, value, cls = "") {
            return `
            <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6 space-y-2 ${cls}">
              <div class="flex items-center gap-2"><i data-feather="${icon}"></i><h4 class="font-bold">${title}</h4></div>
              <p class="text-sm">${value}</p>
            </div>`;
        }

        function moduleCard(name, status) {
            const cls = status.startsWith('NO') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
            return `
            <div class="relative">
              ${card('cpu', name, status, cls)}
              <button onclick="verifyModule('${name}')" class="absolute bottom-2 right-2 bg-indigo-500 hover:bg-indigo-600 text-white text-xs px-2 py-1 rounded">Verificar</button>
            </div>`;
        }

        function sensorCard(icon, title, value, cls = "") {
            return `
            <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6 space-y-2 ${cls}">
              <div class="flex items-center gap-2"><i data-feather="${icon}"></i><h4 class="font-bold">${title}</h4></div>
              <p class="text-sm">${value}</p>
            </div>`;
        }

        // Sparklines (ejemplo estático)
        function sparklineHTML() {
            return `<canvas id="sparklineChart" class="sparkline"></canvas>`;
        }

        function renderSparkline() {
            const ctx = document.getElementById('sparklineChart').getContext('2d');
            if (ctx._chart) { ctx._chart.destroy(); }
            ctx._chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 12 }, (_, i) => i + 1),
                    datasets: [{
                        data: [23, 24, 24, 25, 24, 23, 22, 23, 24, 25, 24, 23],
                        borderColor: '#3b82f6',
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: false,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { display: false }, y: { display: false } },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        }

        // Tabla de accesos diarios
        function accessTableHTML(dateStr) {
            const events = {
                '2025-06-05': ['08:01: Puerta Abierta', '08:03: Puerta Cerrada', '12:15: Puerta Abierta', '12:20: Puerta Cerrada'],
                '2025-06-04': ['09:10: Puerta Abierta', '09:12: Puerta Cerrada']
            };
            const todays = events[dateStr] || [];
            return `
            <div class="max-h-60 overflow-y-auto">
              <table class="min-w-full text-sm divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-100 dark:bg-slate-700">
                  <tr><th class="px-3 py-2 text-left">Hora</th><th class="px-3 py-2 text-left">Evento</th></tr>
                </thead>
                <tbody>
                  ${todays.map(e => {
                const [h, ...rest] = e.split(': ');
                return `<tr><td class="px-3 py-1">${h}</td><td class="px-3 py-1">${rest.join(': ')}</td></tr>`;
            }).join('')}
                </tbody>
              </table>
            </div>`;
        }

        // Tabla de huellas
        function fingerTable() {
            return `
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-100 dark:bg-slate-700">
                  <tr><th class="px-3 py-2 text-left">ID Usuario</th><th class="px-3 py-2 text-left">Huella ID</th><th class="px-3 py-2 text-left">Acciones</th></tr>
                </thead>
                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                  <tr><td class="px-3 py-1">1</td><td class="px-3 py-1">H-001</td><td class="px-3 py-1"><button class="text-red-500 hover:underline">Eliminar</button></td></tr>
                </tbody>
              </table>
            </div>`;
        }

        // Formulario de gestión de cuentas
        function accountManager() {
            return `
            <form class="bg-white dark:bg-slate-800 rounded-lg shadow p-6 space-y-4">
              <div class="flex flex-col sm:flex-row gap-4">
                <input placeholder="Usuario" class="flex-1 px-3 py-2 rounded border border-slate-300 dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-indigo-500" />
                <input type="password" placeholder="Contraseña" class="flex-1 px-3 py-2 rounded border border-slate-300 dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-indigo-500" />
                <select class="px-3 py-2 rounded border border-slate-300 dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-indigo-500"><option>admin</option><option>root</option></select>
                <button class="btn">Crear</button>
              </div>
            </form>`;
        }

        // Definición de secciones
        const sections = {
            home: `
            <section class="space-y-8">
              <div class="relative overflow-hidden rounded-lg">
                <div class="absolute inset-0 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 opacity-30"></div>
                <div class="p-10 relative z-10 text-center">
                  <h2 class="text-3xl sm:text-4xl font-bold mb-2">Bienvenido a EduSec</h2>
                  <p class="text-sm sm:text-base text-slate-700 dark:text-slate-200">Tu centro de control unificado para la seguridad física inteligente</p>
                </div>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                ${card('shield', 'Seguridad del Sistema', '<span class="font-medium">Todos los módulos OK</span>', 'bg-green-100 text-green-700')}
                ${card('lock', 'Puerta', `<span id="homeDoorState">🔒 Cerrada</span>`, 'bg-gray-100 dark:bg-gray-700')}
                ${sensorCard('thermometer', 'Temperatura', '<span id="tempValue">24°C</span>', 'bg-blue-100 text-blue-700')}
                ${sensorCard('droplet', 'Humedad', '<span id="humValue">45%</span>', 'bg-cyan-100 text-cyan-700')}
              </div>
              <div class="mt-6">
                <h4 class="text-lg font-semibold mb-2">Histórico de Temperatura (últimas 12 horas)</h4>
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-4 h-20">
                  ${sparklineHTML()}
                </div>
              </div>
            </section>`,

            acceso: `
            <section class="space-y-6">
              <h3 class="text-2xl font-semibold border-b border-slate-200 dark:border-slate-700 pb-2">🔐 Control de Acceso</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                ${card('lock', 'Estado Puerta', `<span id="doorState">🔒 Cerrada</span>`, 'bg-gray-100 dark:bg-gray-700')}
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6 space-y-4">
                  <div class="flex justify-between items-center">
                    <h4 class="font-bold">Accesos del Día</h4>
                    <div class="flex items-center gap-2">
                      <input type="date" id="filterDate" class="px-2 py-1 rounded border border-slate-300 dark:border-slate-600 bg-transparent text-sm"
                             value="${new Date().toISOString().substring(0, 10)}" onchange="updateAccessTable(this.value)">
                      <button onclick="exportAccessCSV()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm">Exportar CSV</button>
                    </div>
                  </div>
                  <div id="accessContainer">
                    ${accessTableHTML(new Date().toISOString().substring(0, 10))}
                  </div>
                </div>
              </div>
              <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6 space-y-4">
                <div class="flex justify-between items-center">
                  <h4 class="font-bold">Huella Digital</h4>
                  <button id="btnMoreAccion" class="p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700"><i data-feather="more-horizontal"></i></button>
                </div>
                <p class="text-sm" id="fingerSensorState">Sensor huella: <span class="font-medium">OK</span></p>
                <button onclick="toggleFingerAdmin()" class="btn w-full">Administrar Huellas</button>
                <div id="fingerAdmin" class="hidden space-y-4">
                  ${fingerTable()}
                  <button class="btn w-full">Agregar Nueva Huella</button>
                </div>
                <!-- Menú oculto de acciones: Abrir / Cerrar -->
                <div id="menuAcciones" class="hidden absolute bg-white dark:bg-slate-800 shadow rounded mt-2 right-6 w-40 divide-y divide-slate-200 dark:divide-slate-700">
                  <button onclick="cmd('abrir')" class="w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Abrir Puerta</button>
                  <button onclick="cmd('cerrar')" class="w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Cerrar Puerta</button>
                </div>
              </div>
            </section>`,

            monitoreo: `
            <section class="space-y-6">
              <h3 class="text-2xl font-semibold border-b border-slate-200 dark:border-slate-700 pb-2">📡 Monitoreo</h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                ${moduleCard('PIR Sensor', 'OK')}
                ${moduleCard('RFID Reader', 'OK')}
                ${moduleCard('Ultrasonido', 'OK')}
                ${moduleCard('Flama/Agua Sensor', 'NO')}
                ${moduleCard('Buzzer', 'OK')}
                ${moduleCard('Display LCD', 'NO')}
              </div>
            </section>`,

            energia: `
            <section class="space-y-6">
              <h3 class="text-2xl font-semibold border-b border-slate-200 dark:border-slate-700 pb-2">⚡ Alimentación</h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6 space-y-4">
                  <div class="flex items-center gap-2"><i data-feather="zap" class="text-xl"></i><h4 class="font-bold">Fuente de Alimentación</h4></div>
                  <p class="text-sm"><span class="font-medium">AC 120V</span></p>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6 space-y-4">
                  <div class="flex items-center gap-2"><i data-feather="activity" class="text-xl"></i><h4 class="font-bold">Voltaje Actual</h4></div>
                  <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-4">
                    <div id="voltageBar" class="bg-indigo-500 h-4 rounded-full" style="width: 65%"></div>
                  </div>
                  <p class="text-sm"><span id="voltageLevel" class="font-medium">65V</span></p>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6 space-y-4">
                  <div class="flex items-center gap-2"><i data-feather="cpu" class="text-xl"></i><h4 class="font-bold">Consumo</h4></div>
                  <p class="text-sm"><span id="powerConsumption" class="font-medium">1.5A</span></p>
                </div>
              </div>
            </section>`,

            cuentas: `
            <section class="space-y-6">
              <h3 class="text-2xl font-semibold border-b border-slate-200 dark;border-slate-700 pb-2">👥 Gestión de Cuentas</h3>
              ${accountManager()}
            </section>`,

            acerca: `
            <section class="space-y-6">
              <h3 class="text-2xl font-semibold border-b border-slate-200 dark;border-slate-700 pb-2">ℹ️ Acerca de</h3>
              <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6 space-y-4 text-sm">
                <p>Proyecto EduSec v1.0 – Panel Domótico Inteligente.</p>
                <p>Desarrollado por Ulises Roldán &amp; Team, 2025.</p>
                <p>Contacto: soporte@edusec.com</p>
              </div>
            </section>`
        };

        // Definición del menú lateral
        const menuDef = [
            ["home", "home", "Inicio"],
            ["acceso", "lock", "Acceso"],
            ["monitoreo", "activity", "Monitoreo"],
            ["energia", "zap", "Alimentación"],
            ["cuentas", "users", "Cuentas"],
            ["acerca", "info", "Acerca"]
        ];

        function initMenu() {
            const m = document.getElementById('menu');
            m.innerHTML = '';
            menuDef.forEach(([id, ic, label]) => {
                if (id === 'cuentas' && currentUser.role !== 'root') return;
                const b = document.createElement('button');
                b.dataset.sec = id;
                b.className = 'w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700';
                b.innerHTML = `<i data-feather="${ic}"></i><span class="sidebar-text">${label}</span>`;
                b.onclick = () => loadSection(b, id);
                m.appendChild(b);
            });
            feather.replace();
        }

        function loadSection(btn, id) {
            document.querySelectorAll('#menu button').forEach(el => el.classList.remove('bg-indigo-600', 'text-white', 'border-l-4', 'border-indigo-600'));
            btn.classList.add('bg-indigo-600', 'text-white', 'border-l-4', 'border-indigo-600');
            content.innerHTML = sections[id];
            feather.replace();
            applyBtnStyle();
            content.classList.add('fade-in');
            setTimeout(() => content.classList.remove('fade-in'), 400);
            if (id === 'home') renderSparkline();
        }

        const applyBtnStyle = () => {
            document.querySelectorAll('.btn').forEach(b => {
                b.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'text-white', 'px-4', 'py-2', 'rounded');
            });
        };

        const toast = msg => {
            const t = document.createElement('div');
            t.className = 'bg-slate-800 text-white px-4 py-2 rounded shadow';
            t.textContent = msg;
            toastContainer.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        };

        function clockTick() {
            clockNow.textContent = new Date().toLocaleTimeString();
        }
        setInterval(clockTick, 1000);

        async function cmd(a) {
            if (!authToken) {
                toast('No autenticado');
                return;
            }
            try {
                const res = await fetch(`/comando/${a}`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
                const data = await res.json();
                if (!res.ok) {
                    toast(data.error || data.msg || 'Error al ejecutar');
                    return;
                }
                toast(data.resultado || 'Ejecutado');
                if (a === 'abrir') updateDoor('🔓 Abierta');
                if (a === 'cerrar') updateDoor('🔒 Cerrada');
            } catch {
                toast('Error de conexión');
            }
        }
        function updateDoor(s) {
            document.querySelectorAll('#doorState, #homeDoorState').forEach(el => {
                if (el) el.textContent = s;
            });
        }
        function toggleFingerAdmin() {
            const d = document.getElementById('fingerAdmin');
            if (d) d.classList.toggle('hidden');
        }
        function updateAccessTable(dateStr) {
            document.getElementById('accessContainer').innerHTML = accessTableHTML(dateStr);
        }
        function exportAccessCSV() {
            toast('Exportando CSV... (simulado)');
        }
        function verifyModule(mod) {
            toast(`Verificando ${mod}... (simulado)`);
        }

        // Variables globales
        let currentUser = null;
        let authToken = null;

        // Manejo de login
        loginForm.onsubmit = async e => {
            e.preventDefault();
            loginError.classList.add('hidden');
            const u = user.value.trim(), p = pass.value.trim();
            try {
                const res = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                if (!res.ok) {
                    loginError.textContent = data.msg || 'Credenciales incorrectas';
                    loginError.classList.remove('hidden');
                    return;
                }
                authToken = data.token;
                currentUser = { username: data.username, role: data.role };
                lblUser.textContent = data.username;
                loadingOverlay.classList.remove('hidden');
                setTimeout(() => {
                    loginCard.classList.add('hidden');
                    panel.classList.remove('hidden');
                    loadingOverlay.classList.add('hidden');
                    initMenu();
                    document.querySelector('#menu button').click();
                }, 600);
            } catch {
                loginError.textContent = 'Error de conexión';
                loginError.classList.remove('hidden');
            }
        };

        // Otros botones
        themeBtn.onclick = () => {
            document.documentElement.classList.toggle('dark');
            feather.replace();
        };
        logoutBtn.onclick = () => location.reload();
        toggleSidebar.onclick = () => {
            document.body.classList.toggle('sidebar-collapsed');
            feather.replace();
        };

        // Cerrar menúAcciones si clic afuera
        document.addEventListener('click', e => {
            if (e.target.closest('#btnMoreAccion')) {
                const menuAcc = document.getElementById('menuAcciones');
                if (menuAcc) menuAcc.classList.toggle('hidden');
                return;
            }
            const menuAccElem = document.getElementById('menuAcciones');
            if (menuAccElem && !e.target.closest('#menuAcciones')) {
                menuAccElem.classList.add('hidden');
            }
        });

        // Inicializar Feather Icons
        feather.replace();
    </script>
</body>
</html>
